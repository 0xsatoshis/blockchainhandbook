# 区块链技术手册

[胡成武](https://github.com/Colinhuu)（著）&copy; 2019

-----
## 引言

2019年10月24日[习近平在中央政治局第十八次集体学习时强调把区块链作为核心技术自主创新重要突破口](http://www.xinhuanet.com/politics/2019-10/25/c_1125153665.htm)

> 习近平在主持学习时发表了讲话。目前，全球主要国家都在加快布局区块链技术发展。我国在区块链领域拥有良好基础，要加快推动区块链技术和产业创新发展，积极推进区块链和经济社会融合发展。
  
> 习近平强调，要强化基础研究，提升原始创新能力，努力让我国在区块链这个新兴领域走在理论最前沿、占据创新制高点、取得产业新优势。要推动协同攻关，加快推进核心技术突破，为区块链应用发展提供安全可控的技术支撑。要加强区块链标准化研究，提升国际话语权和规则制定权。
  
> ......

区块链是对过往技术的重新组合，是现阶段信息科技创新的高潮。区块链 通过一种全新的信任机制--去信任化(Trustless)，使网络中不熟悉的节点间 也可以直接建立信任关系，每个节点有相同的网络权力，不再存在中心化的服 务器，任一节点停止工作都不会影响系统整体的运作。可以说，以往技术带来 的是生产力的提升，而区块链带来的是生产关系的改变。新的生产关系构建带 来的效率、安全提升将对各行业产生深远影响。

作为互联网从业者，我从2018年初正式关注区块链技术的发展，致力于区块链技术与线下实体产业的融合，在学习区块链的过程中会发现很多生涩难懂的术语，于是边学习边整理，故有此书。当然目前此书的目录排版以及内容，可能都不完善或者有其他待商榷的地方，欢迎大家指正，也希望借此能认识更多的同行者。本书仅作为学习参考使用，部分内容来自于网络，如有侵权，请联系作者删除。

胡成武，二〇一九年十一月，于杭州

## 区块链基础

### 1. 起源-不得不提的比特币

比特币（Bitcoin）的概念最初由中本聪在2008年11月1日提出，并于2009年1月3日正式诞生 [1]  。根据中本聪的思路设计发布的开源软件以及建构其上的P2P网络。比特币是一种P2P形式的虚拟的加密数字货币。点对点的传输意味着一个去中心化的支付系统。

与所有的货币不同，比特币不依靠特定货币机构发行，它依据特定算法，通过大量的计算产生，比特币经济使用整个P2P网络中众多节点构成的分布式数据库来确认并记录所有的交易行为，并使用密码学的设计来确保货币流通各个环节安全性。P2P的去中心化特性与算法本身可以确保无法通过大量制造比特币来人为操控币值。基于密码学的设计可以使比特币只能被真实的拥有者转移或支付。这同样确保了货币所有权与流通交易的匿名性。比特币与其他虚拟货币最大的不同，是其总数量非常有限，具有极强的稀缺性。

具体可以参考比特币白皮书：[比特币:一种点对点的电子现金系统](http://blockchainhandbooks.com/file/比特币白皮书.pdf)

### 2. 基础概念

####        1. 区块与区块链

**区块链**（英语：blockchain或 block chain）是借由密码学串接并保护内容的串连交易记录（又称区块）。每一个区块包含了前一个区块的加密散列、相应时间戳记以及交易数据（通常用默克尔树(Merkle tree)算法计算的散列值表示）

狭义来讲，是一种按照时间顺序将数据区块以顺序相连的方式组合成的一种链式数据结构， 并以密码学方式保证的不可篡改和不可伪造的分布式账本。

广义来讲，是利用块链式数据结构来验证与存储数据、利用分布式节点共识算法来生成和更新数据、利用密码学的方式保证数据传输和访问的安全、利用由自动化脚本代码组成的智能合约来编程和操作数据的一种全新的分布式基础架构与计算方式

可以把区块链理解成一种分布式的交易的共享账本。交易信息将被整理并打包记录在区块中。区块链是一种数据结构，这种结构的数据可以看成是一系列链 接的队列，这些队列通过哈希指针进行关联(与传统意义上的普通指针要区分开， 哈希指针用来指向前一个区块)。

比特币中的链式结构如下:

![](imgs/chain.png)
 
主要分为：公有链、联盟链、私有链

>**公有链/ Public Blockchain**

公有链的任何节点都是向任何人开放的，每个人都可以参与到这个区块链中的计算，而且任何人都可以下载获得完整区块链数据，即全部账本。

>**联盟链/ Consortium Blockchain**

联盟链是指参与每个节点的权限都完全对等，各节点在不需要完全互信的情况下就可以实现数据的可信交换，联盟链的各个节点通常有与之对应的实体机构组织，通过授权后才能加入或退出网络。联盟链是一种公司与公司、组织与组织之间达成联盟的模式。

>**私有链/ Private Blockchain**

在某些区块链的应用场景下，开发者并不希望任何人都可以参与这个系统，因此建立一种不对外公开、只有被许可的节点才可以参与并且查看所有数据的私有区块链，私有链一般适用于特定机构的内部数据管理与审计。

####        2. Merkle Tree
默克尔树（Merkle tree，MT）是一种哈希二叉树，1979年由Ralph Merkle发明。在计算机科学中，二叉树是每个节点最多有两个子树的树结构，每个节点代表一条结构化数据。通常子树被称作“左子树”（left subtree）和“右子树”（right subtree）。二叉树常被用于实现数据快速查询。二叉树如下图所示。

![](imgs/tree.png)

>**1).Merkle树结构**

由一个根节点（root）、一组中间节点和一组叶节点（leaf）组成。叶节点（leaf）包含存储数据或其哈希值，中间节点是它的两个孩子节点内容的哈希值，根节点也是由它的两个子节点内容的哈希值组成。所以Merkle树也称哈希树。

>**2).哈希树的特点**

叶节点存储的是数据文件，而非叶节点存储的是其子节点的哈希值（Hash，通过SHA1、SHA256等哈希算法计算而来），这些非叶子节点的Hash被称作路径哈希值（可以据其确定某个叶节点到根节点的路径）, 叶节点的Hash值是真实数据的Hash值。因为使用了树形结构, 其查询的时间复杂度为 O(logn)，n是节点数量。

![](imgs/hash.png)

默克尔树的另一个特点是，底层数据的任何变动，都会传递到其父节点，一直到树根。

>**3).应用模式**

默克尔树的典型应用场景包括：
* **快速比较大量数据**：当两个默克尔树根相同时，则意味着所代表的数据必然相同（哈希算法决定的）。
* **快速定位修改**：例如上例中，如果 D1 中数据被修改，会影响到Hash0-0，Hash0 和 Root。因此，沿着 Root --> 0 --> 0-0，可以快速定位到发生改变的 D1；
* **零知识证明**：例如如何证明某个数据（D0……D3）中包括给定内容 D0，很简单，构造一个默克尔树，公布 N0，N1，N4，Root，D0拥有者可以很容易检测 D0 存在，但不知道其它内容。
相对于 Hash List，MT的明显的一个好处是可以单独拿出一个分支来（作为一个小树）对部分数据进行校验，这个很多使用场合就带来了哈希列表所不能比拟的方便和高效。正是源于这些优点，MT常用于分布式系统或分布式存储中

>**4).在分布式存储系统中的应用原理**

为了保持数据一致，分布系统间数据需要同步，如果对机器上所有数据都进行比对的话，数据传输量就会很大，从而造成“网络拥挤”。为了解决这个问题，可以在每台机器上构造一棵Merkle Tree，这样，在两台机器间进行数据比对时，从Merkle Tree的根节点开始进行比对，如果根节点一样，则表示两个副本目前是一致的，不再需要任何处理；如果不一样，则沿着hash值不同的节点路径查询，很快就能定位到数据不一致的叶节点，只用把不一致的数据同步即可，这样大大节省了比对时间以及数据的传输量。

>**5).比特币中的Merkle Tree**

比特币区块链系统中的采用的是Merkle二叉树，它的作用主要是快速归纳和校验区块数据的完整性，它会将区块链中的数据分组进行哈希运算，向上不断递归运算产生新的哈希节点，最终只剩下一个Merkle根存入区块头中，每个哈希节点总是包含两个相邻的数据块或其哈希值。
在比特币系统中使用Merkle树有诸多优点：首先是极大地提高了区块链的运行效率和可扩展性，使得区块头只需包含根哈希值而不必封装所有底层数据，这使得哈希运算可以高效地运行在智能手机甚至物联网设备上；其次是Merkle树可支持“简化支付验证协议”（SPV），即在不运行完整区块链网络节点的情况下，也能够对交易数据进行检验。所以，在区块链中使用Merkle树这种数据结构是非常具有意义的。

####        3. 哈希算法

**散列函数**（英语：Hash function）又称**散列算法、哈希函数**，是一种从任何一种数据中创建小的数字“指纹”的方法。散列函数把消息或数据压缩成摘要，使得数据量变小，将数据的格式固定下来。该函数将数据打乱混合，重新创建一个叫做散列值（hash values，hash codes，hash sums，或hashes）的指纹。散列值通常用一个短的随机字母和数字组成的字符串来代表。好的散列函数在输入域中很少出现散列冲突。在散列表和数据处理中，不抑制冲突来区别数据，会使得数据库记录更难找到。

![](imgs/hashfun.png)

> **1).确定性(Deterministic)** 

对于同一个输入，无论用哈希函数计算多少次，都会得到相同的结果。
> **2).快速计算** 

对于输入的字符串，能在合理的时间内算出哈希函数的输出，否则会影响系
统的性能。 
> **3).隐秘性**

如果我们已知字符串 A 的哈希值是 H(A)，那么我们没有可行的办法算出 A 是什么。注意，这里说的是 “不可行” 而不是 “不可能”。
在已知哈希值的情况下， 尽管可以通过暴力破解的方法找到输入的字符串 是什么，但这会花费很长长长长长的时间，所以不用担心。

> **4).抗篡改能力** 

对于任意一个输入，哪怕是很小的改动，其哈希改变也会非常大。

> **5).抗碰撞能力** 

碰撞是指，对于相同的输入，经过哈希计算后产生了不同的输出。具有抗碰撞能力就是对于大部分的输入都有独一无二的输入。 这里说的是”大部分”， 因为找不到碰撞，并不意味不存在碰撞。
但对于 SHA -256 之类的哈希函数，需要花费很长的时间来找到碰撞。所以 我们完全可以认为 if H(A) = H(B) 那么 A=B.

**非对称加密**

非对称加密算法是一种密钥的保密方法。非对称加密算法需要两个密钥:公 开密钥(publickey)和私有密钥(privatekey)。 公开密钥与私有密钥是一对， 如果用公开密钥对数据进行加密，只有用对应的私有密钥才能解密;如果用私有 密钥对数据进行加密，那么只有用对应的公开密钥才能解密。

![](imgs/encrypt.png)

```
1)、A 要向 B 发送信息、A 和 B 都要生成一对用于加密和解密的公钥和私 钥
2)、A 的私钥保密，A 的公钥告诉 B;B 的私钥保密，B 的公钥告诉 A。 
3)、A 要给 B 发送信息时，A 用 B 的公钥加密信息，因为 A 知道 B 的公钥。 
4)、A 将这个消息发给 B(已经用 B 的公钥加密消息)。
5)、B 收到这个消息后，B 用自己的私钥解密 A 的消息。其他所有收到这个报文的人都无法解密，因为只有 B 才有 B 的私钥。
```
####        4. 分叉、孤块与叔块

**分叉**含有数个定义：
* 一条区块链分开成两条区块链
* 一个协议的改变或两个区块拥有相同的高度

分叉可分为**意外分叉**和**有意分叉**。

>**意外分叉**

当两个或以上的矿工在几乎相同的时间成功挖到区块，便会出现意外分叉。 此时，矿工便会分别在两条分叉上各自挖矿，直至其中一条分叉比其他分叉更长。（这代表矿工对采纳哪一个分叉已达成共识）因此，矿工网络随后便会放弃挖掘其他分叉。被抛弃的区块被称为孤立区块。因此，不少密码货币使用者，均要求交易需要多次确认，以防止意外分叉使交易所在之区块变为无效。

>**有意分叉**

有意分叉则对原区块链作出修改，可再分类如下：
新版本和旧版本中的区块能够相互兼容，称为“软分叉”，不能相互兼容就称为“硬分叉”。

* 硬分叉

硬分叉之中新分叉所产生之区块将被旧软件视为无效。因此所有参与者，包括交易服务器以及矿工（节点），都必须更新软件，才能继续运行新分叉。[4]如有节点组继续使用旧软件，而其他节点使用新的软件，便有可能产生分裂成两只货币。

* 软分叉

与硬分叉相比，软分叉所产生之区块能够被旧软件识别为有效区块，即区块 向下兼容。然而，旧软件所产生之区块则未必在新规则下有效。

**孤块(orphan block)**：在比特币协议中，最长的链被认为是绝对的正确。如果一个块不是最长链的一部分，那么它被称为是“孤块”。一个孤立的块是一个块，它也是合法的，但是发现的稍晚，或者是网络传输稍慢，而没有能成为最长的链的一部分。在比特币中，孤块没有意义，随后将被抛弃，发现这个孤块的矿工也拿不到采矿相关的奖励。

而在以太坊中，不能跻身主链的区块都是孤块，如果这些孤块能够被后来的区块通过Uncle字段收留，则这些孤块会成为叔块

**“叔块”(uncle block)**：Ethereum的GHOST协议，不认为孤块没有价值，而是会给与发现孤块的矿工以回报。在以太坊中，孤块被称为“叔块”(uncle block)，它们可以为主链的安全作出贡献。
叔块的奖励计算有些复杂，公式为：
```
叔块奖励 = ( 叔块高度 + 8 - 包含叔块的区块的高度 ) * 普通区块奖励 / 8
```

####        5. 分布式、P2P、非对称加密
> **0).点对点/ Peer-to-Peer / P2P**

通过允许单个节点与其他节点直接交互，无需通过中介机构，从而实现整个系统像有组织的集体一样运作的系统。

> **1).去中心化**

去中心化是互联网发展过程中形成的社会关系形态和内容，是相对于“中心化”而言的新型网络内容的生产过程。在计算机技术领域，去中心化结构使用分布式核算和存储，不存在中心化的节点，任意节点的权利和义务都是均等的，系统中的数据块由整个系统中具有维护功能的节点来共同维护，任一节点停止工作都不会影响系统整体的运作。

> **2).分布式**

分布式网络存储技术是将数据分散的存储于多台独立的机器设备上。分布式网络存储系统采用可扩展的系统结构，利用多台存储服务器分担存储负荷，利用位置服务器定位存储信息，不但解决了传统集中式存储系统中单存储服务器的瓶颈问题，还提高了系统的可靠性、可用性和扩展性，这种组织方式能有效提升信息的传递效率。

> **3).两者的异同**

下图能够很好地反映“中心化”、“去中心化”、“分布式”、“点对点”的异同。

![](imgs/distributed.png)

关于“去中心化”和“分布式”的区别大概可以总结为：去中心化是分布式网络结构中的一种，所有的去中心化都是采用分布式网络结构的，而分布式网络结构可能是“中心化”也可能是“去中心化”的。

**去中心化**：相对于“中心化”概念，在去中心化的系统网络里，每一个参与者（节点）都是平等且自由的关系，没有谁依赖谁。

**多中心化**：和去中心化有一些相近， 由多个中心节点组成的平等网络，节点的参与和退出可能有所要求和限制。

**分布式**：分布也可以说分散，节点是分散的，分布式的网络节点之间互联互通，当任何一个节点出现故障时其它节点仍然能够继续工作。

####        6. UXTO模型、账户余额模型

> **1).UTXO**

**UTXO （ Unspent Transaction Output）**，直接翻译出来的意思是“未花费的输出”，在比特币系统里，没有设计使用交易者账户系统，而是记录一笔又一笔的交易，而且交易输入（资金来源，包括挖矿所得）=交易输出（即UTXO）+矿工费，比特币就在一个接一个的交易输入与输出中流动起来。
由挖矿所得创建的比特币交易，是每个区块中的首个交易，又称之为coinbase交易，它由矿工创建，没有上一笔交易输出。
在比特币交易中 UTXO 就是基本单位，一个UTXO一旦被创建就不可被继续分割，它只能当作是下一笔交易的输入被花费掉，花费后产生新的UTXO，这样周而复始地实现货币的价值转移。所以我们在比特币钱包中所看到的账户余额，实际上是钱包通过扫描区块链并聚合所有属于该用户的UTXO计算得来的。
比特币的UXTO系统遵守两个规则：
* 1、 除了 CoinBase（挖矿交易）之外，所有的资金来源都必须来自前面某一个或者几个交易的UXTO；
* 2、任何一笔交易的输入总量必须等于输出总量，等式两边必须配平。

>**2).账户余额**

**账户/余额模型**会将每个账户的余额保持为全球状态。 检查帐户的余额以确保其大于或等于支出交易金额。

>**3).优缺点**

**UTXO模型**的好处是：


* **可扩展性** - 由于可以同时处理多个UTXO，因此可以实现并行事务并鼓励可伸缩性创新。
* **隐私** - 甚至比特币也不是一个完全匿名的系统，但只要用户为每笔交易使用新地址，UTXO就可以提供更高级别的隐私。 如果需要增强隐私性，可以考虑更复杂的方案，例如环签名。

**账户/余额模型**的好处是：

* **简单性** - 以太坊选择了一种更直观的模式，以便为复杂智能合约的开发人员带来益处，尤其是那些需要国家信息或涉及多方的开发人员。 一个例子是一个智能合约，跟踪各国根据它们执行不同的任务。 UTXO的无状态模型会迫使交易包含状态信息，这不必要地使合约的设计复杂化。
* **效率** - 除了简单之外，账户/余额模型更加高效，因为每笔交易只需要验证发送账户是否有足够的余额来支付交易。


###    3. 发展阶段
```
区块链的进化方式是：
▪ 区块链1.0——数字货币
▪ 区块链2.0——智能合约（可编程区块链）
▪ 区块链3.0——分布式社会（可编程商业经济）
```

> **1. 技术实验阶段（2007—2009）**

化名中本聪的比特币创始人从2007年开始探索用一系列技术创造一种新的货币——比特币，2008年10月31日发布了《比特币白皮书》，2009年1月3日比特币系统开始运行。

> **2. 极客小众阶段（2010-2012）**

2010年2月6日诞生了第一个比特币交易所，5月22日有人用10000个比特币购买了2个披萨。2010年7月17日著名比特币交易所Mt.gox成立，这标志着比特币真正进入了市场。

> **3. 市场酝酿阶段（2013-2015）**

2013年初比特币价格13美元，3月18日金融危机中的塞浦路斯政府关闭银行和股市，推动比特币价格飙升，4月最高至266美元。8月20日德国政府确认比特币的货币地位。10月14日中国百度宣布开通比特币支付。11月美国参议院听证会明确了比特币的合法性。11月19日比特币达到1242美元新高！

> **4. 进入主流阶段（2016-2018）**

世界主流经济不确定性增强，具有避险功能从而与主流经济呈现替代关系的比特币开始复苏，尽管中国市场受到政策的严厉遏制，但韩国、日本、拉美等市场快速升温，比特币价格从2016年初的400美元最高飙升至2017年底的20000美元，翻了50倍。

> **5. 产业落地阶段（约2019-2021）**

在市场狂乱之后，2018年的虚拟货币和区块链会在市场、监管、认知等各方面进行调整，回归理性。

> **6、产业成熟阶段（约2022-2025）**

各种区块链项目落地见效之后，会进入激烈而快速的市场竞争和产业整合阶段，三五年内形成一些行业龙头，完成市场划分，区块链产业格局基本形成，相关法律法规基本健全，区块链对社会经济各领域的推动作用快速显现，加密货币将成为主流货币，经济理论会出现重大调整，社会政治文化也将发生相应变化，国际政治经济关系出现重大调整，区块链在全球范围内对人们的生活产生广泛而深刻的影响。

###    4. 特性
####        1. 去中心化
####        2. 匿名性
####        3. 不可篡改
####        4. 去信任
####        5. 开放性

## 区块链技术
###    1. 共识算法
####        1. POW、POS、DPOS
####        2. Paxos
####        3. PBFT
####        4. Raft
####        5. Ripple
####       6. Kafka、SOLO
####        7. POF、POC
###    2. 智能合约
###    3. 高频率协议
####        1. BIP32、BIP39、BIP44
####        2. ERC20、ERC721
###    4. 扩展性
####        1. 侧链（多条独立链）
####        2. 超大区块（增加区块容量）
####        3. 双层网络（channels和plasma）
####        4. 分片
####        5. 跨链
#####            1. 侧链
#####            2. 中继
#####            3. 公证人
#####            4. 哈希锁定
####        6. 其他
#####            1. 隔离见证
#####            2. DAG有向无环图
#####            3. 闪电网络
#####           4. 雷电网络
####        7. 链上扩容、链下扩容
###    5. 安全
####        1. 多重签名
####        2. 环签名
###    6. 隐私保护
####        1. 混币
####        2. 环签名
####        3. 同态加密
####        4. 零知识证明
####        5. 多方安全计算
###    7. 其他术语
####        1. IPFS
####        2. 石墨烯
####       3. DeFi
 
## 主要链
###    1. 比特币
###    2. 以太坊
###    3. EOS
###    4. HyperLedger Fabric
###    5. 其他区块链
####        1. EOS Force
####        2. Bytom
####        3. NEO
####        4. QTUM
####        5. GXChain
####        6. BAT
####        7. 国外的R3 CEV以及国内的R3 ChinaLedger 未开源
## 应用场景
###    1. 防伪溯源
###    2. 区块链农业
###    3. 政务
###    4. 电子票据
###    5. 版权保护
###    6. 金融
####        1. 证券
####        2. 保险
####        3. 供应链金额
####       4. 支付清算
## 发展趋势
## 风险
###    1. 量子计算
###    2. 分叉：信任危机
###    3. 双花、51%算力问题

## 关于作者
[胡成武]() 非主流程序员、坚定的区块链技术与应用践行者、独立房产投资人。

## 尾声
> 看了这么多，区块链是否真的那么深不可测呢？有了《区块链技术手册》，哪里不会点哪里。
